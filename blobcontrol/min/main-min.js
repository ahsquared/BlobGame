function setupGame(){function e(r){r.preventDefault(),IS_IOS?(a.play(),a.volume=0):(t.play(),t.volume=0),o.className="hide",n.removeEventListener("touchstart",e),n.removeEventListener("click",e),connectToGame()}var t=document.getElementById("VideoPlayer"),a=document.getElementById("AudioPlayer"),o=document.getElementById("BeginTheParty"),n=document.getElementById("BeginThePartyBtn");n.addEventListener("touchstart",e),n.addEventListener("click",e)}function connectToGame(){socket=io.connect("http://"+location.hostname,{port:8081,rememberTransport:!1}),socket.on("connect",function(){socket.emit("config",{server:{port:3333,host:location.hostname},client:{port:3334,host:location.hostname}}),game.init()}),socket.on("message",function(e){"bounce"===e[0]&&window.navigator.vibrate(200),"partNumber"===e[0]&&drawStaff(staveCanvasWrapper,staveCanvasWrapper.offsetWidth,inCParts[e[1]])})}function drawStaff(e,t,a){e.innerHTML='<canvas id="stave"></canvas>';var o=document.getElementById("stave"),n=new Vex.Flow.Renderer(o,Vex.Flow.Renderer.Backends.CANVAS),r=t-40,i=n.getContext(),s=new Vex.Flow.Stave(10,0,r);s.addClef("treble").setBegBarType(Vex.Flow.Barline.type.REPEAT_BEGIN).setEndBarType(Vex.Flow.Barline.type.REPEAT_END).setContext(i).draw();var c=new Vex.Flow.Voice({num_beats:a.voice.num_beats,beat_value:a.voice.beat_value,resolution:Vex.Flow.RESOLUTION}),l,m;a.beams&&(m=a.beams.map(function(e){return a.notes[e]}),console.log(a.beams),l=new Vex.Flow.Beam(m)),c.addTickables(a.notes);var u=(new Vex.Flow.Formatter).joinVoices([c]).format([c],r);c.draw(i,s),a.beams&&l.setContext(i).draw()}var IS_IOS=/(iPad|iPhone|iPod)/g.test(navigator.userAgent),staveCanvasWrapper=document.getElementById("stave-wrapper"),socket,game,inCParts;game={shapeNumber:0,init:function(){gyro.frequency=40;var e=document.getElementById("wrapper"),t=document.getElementById("shape"),a=document.getElementById("info"),o=document.getElementById("content"),n=!1,r=6,i=document.getElementById("staff");gyro.startTracking(function(t){if(null!=t.alpha&&!n){game.initOrientation.alpha=t.alpha,game.initOrientation.beta=Math.abs(t.beta),game.initOrientation.gamma=Math.abs(t.gamma),n=!0,game.shapeNumber=game.randomIntFromInterval(1,6),a.className="shape"+game.shapeNumber;var o=game.randomIntFromInterval(1,360)/360,r=o+",0.8,0.65",i=game.hslToRgb(o,.8,.65),s=i[0]+","+i[1]+","+i[2];socket.emit("message","/create "+(game.shapeNumber-1)+"|"+s+"|"+socket.socket.sessionid)}if(n){var c={alpha:t.alpha-game.initOrientation.alpha,beta:t.beta-game.initOrientation.beta,gamma:t.gamma-game.initOrientation.gamma},l=game.getAccelerationWithoutGravity(t);socket.emit("message","/rot "+c.alpha+"|"+c.beta+"|"+c.gamma+"|"+socket.socket.sessionid),socket.emit("message","/acc "+l.x+"|"+l.y+"|"+l.z+"|"+socket.socket.sessionid);var m=game.getSmoothRotation(c.alpha,c.beta,c.gamma);e.style.backgroundColor="hsl("+Math.abs(t.alpha).toFixed(0)+", 80%, 65%)"}})},hslToRgb:function(e,t,a){function o(e,t,a){return 0>a&&(a+=1),a>1&&(a-=1),1/6>a?e+6*(t-e)*a:.5>a?t:2/3>a?e+(t-e)*(2/3-a)*6:e}var n,r,i;if(0==t)n=r=i=a;else{var s=.5>a?a*(1+t):a+t-a*t,c=2*a-s;n=o(c,s,e+1/3),r=o(c,s,e),i=o(c,s,e-1/3)}return[Math.round(255*n),Math.round(255*r),Math.round(255*i)]},userAgent:navigator.userAgent.toLowerCase(),isFirefox:function(){return this.userAgent.indexOf("firefox")>0?!0:!1},randomIntFromInterval:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},initOrientation:{alpha:0,beta:0,gamma:0},accFilteringFactor:.1,rotFilteringFactor:.1,setStyle:function(){var e={};return function(t,a,o){if(t in o.style)return void(o.style[t]=a);if(t in e)return void(o.style[e[t]]=a);var n=["Moz","webkit","ms"],r=t.replace(t[0],t[0].toUpperCase());n.forEach(function(n){var i=n+r;i in o.style&&(e[t]=i,o.style[i]=a)})}}(),rotateShape:function(e,t){var a="perspective(500) rotateZ("+e.alpha+"deg) rotateX("+e.beta+"deg) rotateY("+e.gamma+"deg)";this.setStyle("transform",a,t)},currentRotation:{alpha:0,beta:0,gamma:0},getSmoothRotation:function(e,t,a){return this.currentRotation.alpha=(e*this.rotFilteringFactor+this.currentRotation.alpha*(1-this.rotFilteringFactor)).toFixed(1),this.currentRotation.beta=(t*this.rotFilteringFactor+this.currentRotation.beta*(1-this.rotFilteringFactor)).toFixed(1),this.currentRotation.gamma=(a*this.rotFilteringFactor+this.currentRotation.gamma*(1-this.rotFilteringFactor)).toFixed(1),this.currentRotation},currentAccel:{x:0,y:0,z:0},getAccelerationWithoutGravity:function(e){var t={};return this.currentAccel.x=e.x*this.accFilteringFactor+this.currentAccel.x*(1-this.accFilteringFactor),this.currentAccel.y=e.y*this.accFilteringFactor+this.currentAccel.y*(1-this.accFilteringFactor),this.currentAccel.z=e.z*this.accFilteringFactor+this.currentAccel.z*(1-this.accFilteringFactor),t.x=(e.x-this.currentAccel.x).toFixed(1),t.y=(e.y-this.currentAccel.y).toFixed(1),t.z=(e.z-this.currentAccel.z).toFixed(1),t}},inCParts=[{notes:[new Vex.Flow.StaveNote({keys:["e/4"],duration:"q"}).addModifier(0,new Vex.Flow.GraceNoteGroup([new Vex.Flow.GraceNote({keys:["c/4"],duration:"16",slash:!1})],!0).beamNotes()),new Vex.Flow.StaveNote({keys:["e/4"],duration:"q"}).addModifier(0,new Vex.Flow.GraceNoteGroup([new Vex.Flow.GraceNote({keys:["c/4"],duration:"16",slash:!1})],!0).beamNotes()),new Vex.Flow.StaveNote({keys:["e/4"],duration:"q"}).addModifier(0,new Vex.Flow.GraceNoteGroup([new Vex.Flow.GraceNote({keys:["c/4"],duration:"16",slash:!1})],!0).beamNotes())],voice:{num_beats:3,beat_value:4}},{notes:[new Vex.Flow.StaveNote({keys:["e/4"],duration:"8"}).addModifier(0,new Vex.Flow.GraceNoteGroup([new Vex.Flow.GraceNote({keys:["c/4"],duration:"16",slash:!1})],!0).beamNotes()),new Vex.Flow.StaveNote({keys:["f/4"],duration:"8"}),new Vex.Flow.StaveNote({keys:["e/4"],duration:"q"})],beams:[0,1],voice:{num_beats:2,beat_value:4}}],setupGame();